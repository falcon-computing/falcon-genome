pipeline {
agent {label 'merlin'}
    stages {
        stage ("build-aws-falcon-genome") {
            steps {
                 dir("ws-falcon-genome") {
                    checkout scm
                    sh "rm -rf release"
                    sh "mkdir release"
                    script { 
                    dir("release"){
                        sh "source /curr/software/util/modules-tcl/init/bash"
                        sh "module load sdx/17.4; cmake3 -DCMAKE_BUILD_TYPE=Release -DRELEASE_VERSION=aws -DDEPLOYMENT_DST=aws -DCMAKE_INSTALL_PREFIX=/curr/limark/falcon2/bin .."
                        sh "make -j 8"
//                        sh "make install"
                        sh "make test"
                        }
                     }
                  }
               }    
            }
        stage ("build-hwc-falcon-genome") {
              steps {
                     dir("ws-falcon-genome") {                      
                        sh "rm -rf release"
                        sh "mkdir release"
                        script { 
                        dir("release"){
                            sh "source /curr/software/util/modules-tcl/init/bash"
                            sh "module load sdx/17.4; cmake3 -DCMAKE_BUILD_TYPE=Release -DRELEASE_VERSION=hwc -DDEPLOYMENT_DST=hwc -DCMAKE_INSTALL_PREFIX=/curr/limark/falcon-hwc/bin .."
                            sh "make -j 8"
 //                           sh "make install"
                            sh "make test"
                            }
                         }
                      }
                   }    
                }
                stage ("build-local-falcon-genome") {
                  steps {
                    dir("ws-falcon-genome") {                      
                      sh "rm -rf release"
                      sh "mkdir release"
                      script { 
                        dir("release"){
                          sh "source /curr/software/util/modules-tcl/init/bash"
                          sh "module load xrt; cmake3 -DCMAKE_BUILD_TYPE=Release -DRELEASE_VERSION=Internal -DDEPLOYMENT_DST=Internal -DCMAKE_INSTALL_PREFIX=/curr/limark/falcon-local/bin .."
                          sh "make -j 8"
//                          sh "make install"
                          sh "make test"
                        }
                      }
                    }
                  }    
                }  
         }
     post {
            always {

                emailext attachLog: true, body: "${currentBuild.currentResult}: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}console",
                    recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']],
                    subject: "Jenkins Build ${currentBuild.currentResult}: Job ${env.JOB_NAME}",
                    to: 'allwu@falcon-computing.com, roshantha@limarktech.com'

        }
    }
}
